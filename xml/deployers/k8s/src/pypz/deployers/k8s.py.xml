<?xml-stylesheet type="text/xsl" href="../../../../../../mypy-html.xslt"?><mypy-report-file name="deployers\k8s\src\pypz\deployers\k8s.py" module="deployers.k8s.src.pypz.deployers.k8s"><line any_info="No Anys on this line!" content="# =============================================================================" number="1" precision="empty"/><line any_info="No Anys on this line!" content="# Copyright (c) 2024 by Laszlo Anka. All rights reserved." number="2" precision="empty"/><line any_info="No Anys on this line!" content="#" number="3" precision="empty"/><line any_info="No Anys on this line!" content="# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);" number="4" precision="empty"/><line any_info="No Anys on this line!" content="# you may not use this file except in compliance with the License." number="5" precision="empty"/><line any_info="No Anys on this line!" content="# You may obtain a copy of the License at" number="6" precision="empty"/><line any_info="No Anys on this line!" content="#" number="7" precision="empty"/><line any_info="No Anys on this line!" content="#     http://www.apache.org/licenses/LICENSE-2.0" number="8" precision="empty"/><line any_info="No Anys on this line!" content="#" number="9" precision="empty"/><line any_info="No Anys on this line!" content="# Unless required by applicable law or agreed to in writing, software" number="10" precision="empty"/><line any_info="No Anys on this line!" content="# distributed under the License is distributed on an &quot;AS IS&quot; BASIS," number="11" precision="empty"/><line any_info="No Anys on this line!" content="# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied." number="12" precision="empty"/><line any_info="No Anys on this line!" content="# See the License for the specific language governing permissions and" number="13" precision="empty"/><line any_info="No Anys on this line!" content="# limitations under the License." number="14" precision="empty"/><line any_info="No Anys on this line!" content="# =============================================================================" number="15" precision="empty"/><line any_info="No Anys on this line!" content="import base64" number="16" precision="precise"/><line any_info="No Anys on this line!" content="import time" number="17" precision="precise"/><line any_info="No Anys on this line!" content="from typing import Any, Optional" number="18" precision="precise"/><line any_info="No Anys on this line!" content="" number="19" precision="empty"/><line any_info="No Anys on this line!" content="from kubernetes.client import Configuration, ApiClient, CoreV1Api, V1SecretList, V1Secret, V1ObjectMeta, V1Pod, \" number="20" precision="any"/><line any_info="No Anys on this line!" content="    ApiException" number="21" precision="empty"/><line any_info="No Anys on this line!" content="from kubernetes import config" number="22" precision="any"/><line any_info="No Anys on this line!" content="import certifi" number="23" precision="precise"/><line any_info="No Anys on this line!" content="" number="24" precision="empty"/><line any_info="No Anys on this line!" content="from pypz.core.commons.loggers import DefaultContextLogger, ContextLogger" number="25" precision="any"/><line any_info="No Anys on this line!" content="from pypz.core.specs.operator import Operator" number="26" precision="any"/><line any_info="No Anys on this line!" content="from pypz.core.specs.pipeline import Pipeline" number="27" precision="any"/><line any_info="No Anys on this line!" content="from pypz.deployers.base import Deployer, DeploymentState" number="28" precision="any"/><line any_info="No Anys on this line!" content="from pypz.executors.commons import ExecutionMode" number="29" precision="any"/><line any_info="No Anys on this line!" content="" number="30" precision="empty"/><line any_info="No Anys on this line!" content="" number="31" precision="empty"/><line any_info="No Anys on this line!" content="class DeploymentConflictException(Exception):" number="32" precision="precise"/><line any_info="No Anys on this line!" content="    pass" number="33" precision="precise"/><line any_info="No Anys on this line!" content="" number="34" precision="empty"/><line any_info="No Anys on this line!" content="" number="35" precision="empty"/><line any_info="No Anys on this line!" content="class DeploymentNotFoundException(Exception):" number="36" precision="precise"/><line any_info="No Anys on this line!" content="    pass" number="37" precision="precise"/><line any_info="No Anys on this line!" content="" number="38" precision="empty"/><line any_info="No Anys on this line!" content="" number="39" precision="empty"/><line any_info="No Anys on this line!" content="class DeploymentException(Exception):" number="40" precision="precise"/><line any_info="No Anys on this line!" content="    pass" number="41" precision="precise"/><line any_info="No Anys on this line!" content="" number="42" precision="empty"/><line any_info="No Anys on this line!" content="" number="43" precision="empty"/><line any_info="No Anys on this line!" content="class KubernetesParameter:" number="44" precision="precise"/><line any_info="No Anys on this line!" content="    &quot;&quot;&quot;" number="45" precision="empty"/><line any_info="No Anys on this line!" content="    This class represents all Pod fields that can be updated via instance parameters" number="46" precision="empty"/><line any_info="No Anys on this line!" content="    &quot;&quot;&quot;" number="47" precision="empty"/><line any_info="No Anys on this line!" content="" number="48" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x20)" content="    def __init__(self," number="49" precision="imprecise"/><line any_info="No Anys on this line!" content="                 imagePullPolicy: Optional[str] = None," number="50" precision="precise"/><line any_info="No Anys on this line!" content="                 restartPolicy: Optional[str] = None," number="51" precision="precise"/><line any_info="No Anys on this line!" content="                 env: Optional[list[dict]] = None," number="52" precision="precise"/><line any_info="No Anys on this line!" content="                 envFrom: Optional[list[dict]] = None," number="53" precision="precise"/><line any_info="No Anys on this line!" content="                 volumeMounts: Optional[list[dict]] = None," number="54" precision="precise"/><line any_info="No Anys on this line!" content="                 containers: Optional[list[dict]] = None," number="55" precision="precise"/><line any_info="No Anys on this line!" content="                 volumes: Optional[list[dict]] = None," number="56" precision="precise"/><line any_info="No Anys on this line!" content="                 terminationGracePeriodSeconds: Optional[int] = None," number="57" precision="precise"/><line any_info="No Anys on this line!" content="                 serviceAccountName: Optional[str] = None," number="58" precision="precise"/><line any_info="No Anys on this line!" content="                 labels: Optional[dict] = None," number="59" precision="precise"/><line any_info="No Anys on this line!" content="                 containerSecurityContext: Optional[dict] = None," number="60" precision="precise"/><line any_info="No Anys on this line!" content="                 podSecurityContext: Optional[dict] = None," number="61" precision="precise"/><line any_info="No Anys on this line!" content="                 nodeAffinity: Optional[dict] = None," number="62" precision="precise"/><line any_info="No Anys on this line!" content="                 nodeAntiAffinity: Optional[dict] = None):" number="63" precision="precise"/><line any_info="No Anys on this line!" content="        self.imagePullPolicy: Optional[str] = imagePullPolicy" number="64" precision="precise"/><line any_info="No Anys on this line!" content="        self.restartPolicy: Optional[str] = restartPolicy" number="65" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.env: Optional[list[dict]] = env" number="66" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.envFrom: Optional[list[dict]] = envFrom" number="67" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.volumeMounts: Optional[list[dict]] = volumeMounts" number="68" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.containers: Optional[list[dict]] = containers" number="69" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.volumes: Optional[list[dict]] = volumes" number="70" precision="imprecise"/><line any_info="No Anys on this line!" content="        self.terminationGracePeriodSeconds: Optional[int] = terminationGracePeriodSeconds" number="71" precision="precise"/><line any_info="No Anys on this line!" content="        self.serviceAccountName: Optional[str] = serviceAccountName" number="72" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.labels: Optional[dict] = labels" number="73" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.containerSecurityContext: Optional[dict] = containerSecurityContext" number="74" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.podSecurityContext: Optional[dict] = podSecurityContext" number="75" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.nodeAffinity: Optional[dict] = nodeAffinity" number="76" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x6)" content="        self.nodeAntiAffinity: Optional[dict] = nodeAntiAffinity" number="77" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="78" precision="empty"/><line any_info="No Anys on this line!" content="" number="79" precision="empty"/><line any_info="No Anys on this line!" content="class KubernetesDeployer(Deployer):" number="80" precision="precise"/><line any_info="No Anys on this line!" content="    # ========================= class variables ==========================" number="81" precision="empty"/><line any_info="No Anys on this line!" content="" number="82" precision="empty"/><line any_info="No Anys on this line!" content="    _label_key_instance_type = &quot;pypz.io/instance-type&quot;" number="83" precision="precise"/><line any_info="No Anys on this line!" content="    _label_key_exec_mode = &quot;pypz.io/exec-mode&quot;" number="84" precision="precise"/><line any_info="No Anys on this line!" content="    _label_key_part_of = &quot;pypz.io/part-of&quot;" number="85" precision="precise"/><line any_info="No Anys on this line!" content="    _label_key_instance_name = &quot;pypz.io/instance-name&quot;" number="86" precision="precise"/><line any_info="No Anys on this line!" content="    _label_value_pipeline = &quot;pipeline&quot;" number="87" precision="precise"/><line any_info="No Anys on this line!" content="    _label_value_operator = &quot;operator&quot;" number="88" precision="precise"/><line any_info="No Anys on this line!" content="" number="89" precision="empty"/><line any_info="No Anys on this line!" content="    _pipeline_config_secret_key = &quot;pipeline-config&quot;" number="90" precision="precise"/><line any_info="No Anys on this line!" content="" number="91" precision="empty"/><line any_info="No Anys on this line!" content="    _env_var_operator_name = &quot;PYPZ_OPERATOR_INSTANCE_NAME&quot;" number="92" precision="precise"/><line any_info="No Anys on this line!" content="    _env_var_operator_exec_mode = &quot;PYPZ_OPERATOR_EXEC_MODE&quot;" number="93" precision="precise"/><line any_info="No Anys on this line!" content="" number="94" precision="empty"/><line any_info="No Anys on this line!" content="    # ========================= static methods ==========================" number="95" precision="empty"/><line any_info="No Anys on this line!" content="" number="96" precision="empty"/><line any_info="No Anys on this line!" content="    @staticmethod" number="97" precision="empty"/><line any_info="No Anys on this line!" content="    def sanitize(string: str) -&gt; str:" number="98" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x4)" content="        return string.translate(str.maketrans({&quot;_&quot;: &quot;-&quot;, &quot;.&quot;: &quot;-&quot;}))" number="99" precision="precise"/><line any_info="No Anys on this line!" content="" number="100" precision="empty"/><line any_info="No Anys on this line!" content="    # ========================= ctor ==========================" number="101" precision="empty"/><line any_info="No Anys on this line!" content="" number="102" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)&#10;Explicit (x1)" content="    def __init__(self," number="103" precision="imprecise"/><line any_info="No Anys on this line!" content="                 namespace: str = &quot;default&quot;," number="104" precision="precise"/><line any_info="No Anys on this line!" content="                 configuration: Configuration = None," number="105" precision="precise"/><line any_info="No Anys on this line!" content="                 config_file: Any = None):" number="106" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="        if configuration is None:" number="107" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x3)&#10;Explicit (x1)" content="            config.load_kube_config(config_file=config_file)" number="108" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="            configuration = Configuration.get_default_copy()" number="109" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="            configuration.ssl_ca_cert = certifi.where()" number="110" precision="any"/><line any_info="No Anys on this line!" content="" number="111" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x7)" content="        self._core_v1_api: CoreV1Api = CoreV1Api(api_client=ApiClient(configuration=configuration))" number="112" precision="any"/><line any_info="No Anys on this line!" content="" number="113" precision="empty"/><line any_info="No Anys on this line!" content="        self._namespace: str = namespace" number="114" precision="precise"/><line any_info="No Anys on this line!" content="" number="115" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="        self._logger: ContextLogger = \" number="116" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x5)&#10;Explicit (x1)" content="            ContextLogger(DefaultContextLogger(KubernetesDeployer.__name__))" number="117" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        self._logger.set_log_level(&quot;DEBUG&quot;)" number="118" precision="any"/><line any_info="No Anys on this line!" content="" number="119" precision="empty"/><line any_info="No Anys on this line!" content="    # ========================= implemented methods ==========================" number="120" precision="empty"/><line any_info="No Anys on this line!" content="" number="121" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="    def deploy(self, pipeline: Pipeline," number="122" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="               execution_mode: ExecutionMode = ExecutionMode.Standard," number="123" precision="any"/><line any_info="No Anys on this line!" content="               ignore_operators: list[Operator] = None," number="124" precision="precise"/><line any_info="No Anys on this line!" content="               wait: bool = True) -&gt; None:" number="125" precision="precise"/><line any_info="No Anys on this line!" content="        # Check if pipeline is deployed or operators are lingering" number="126" precision="empty"/><line any_info="No Anys on this line!" content="        # ========================================================" number="127" precision="empty"/><line any_info="No Anys on this line!" content="" number="128" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        if self.is_deployed(pipeline.get_full_name()):" number="129" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="            raise DeploymentConflictException(f&quot;Pipeline already deployed: {pipeline.get_full_name()}&quot;)" number="130" precision="any"/><line any_info="No Anys on this line!" content="" number="131" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x8)" content="        for operator in pipeline.get_protected().get_nested_instances().values():" number="132" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x6)" content="            operator_state = self.retrieve_operator_state(operator.get_full_name())" number="133" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="            if DeploymentState.NotExisting != operator_state:" number="134" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                raise DeploymentConflictException(f&quot;Operator is still in active state: &quot;" number="135" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                                                  f&quot;{operator.get_full_name()} - {operator_state}&quot;)" number="136" precision="any"/><line any_info="No Anys on this line!" content="" number="137" precision="empty"/><line any_info="No Anys on this line!" content="        # Deployment" number="138" precision="empty"/><line any_info="No Anys on this line!" content="        # ==========" number="139" precision="empty"/><line any_info="No Anys on this line!" content="" number="140" precision="empty"/><line any_info="No Anys on this line!" content="        try:" number="141" precision="empty"/><line any_info="No Anys on this line!" content="            # Storing all operators' pod name and simple name, since it can be necessary in some" number="142" precision="empty"/><line any_info="No Anys on this line!" content="            # cases like operator restart." number="143" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="            secret_labels = {" number="144" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x7)&#10;Explicit (x1)" content="                KubernetesDeployer.sanitize(operator.get_full_name()): operator.get_simple_name()" number="145" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x8)" content="                for operator in pipeline.get_protected().get_nested_instances().values()" number="146" precision="any"/><line any_info="No Anys on this line!" content="            }" number="147" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)&#10;Explicit (x2)" content="            secret_labels[KubernetesDeployer._label_key_instance_type] = KubernetesDeployer._label_value_pipeline" number="148" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x4)&#10;Explicit (x1)" content="            secret_labels[KubernetesDeployer._label_key_exec_mode] = execution_mode.value" number="149" precision="any"/><line any_info="No Anys on this line!" content="" number="150" precision="empty"/><line any_info="No Anys on this line!" content="            # Deploy configuration secret" number="151" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="            secret: V1Secret = V1Secret(" number="152" precision="any"/><line any_info="No Anys on this line!" content="                api_version=&quot;v1&quot;," number="153" precision="precise"/><line any_info="No Anys on this line!" content="                kind=&quot;Secret&quot;," number="154" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                metadata=V1ObjectMeta(" number="155" precision="any"/><line any_info="No Anys on this line!" content="                    namespace=self._namespace," number="156" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="                    name=pipeline.get_full_name()," number="157" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="                    labels=secret_labels" number="158" precision="imprecise"/><line any_info="No Anys on this line!" content="                )," number="159" precision="empty"/><line any_info="No Anys on this line!" content="                data={" number="160" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)&#10;Explicit (x1)" content="                    KubernetesDeployer._pipeline_config_secret_key: base64.b64encode(" number="161" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="                        pipeline.__str__().encode()).decode()" number="162" precision="any"/><line any_info="No Anys on this line!" content="                }," number="163" precision="empty"/><line any_info="No Anys on this line!" content="                type=&quot;Opaque&quot;," number="164" precision="precise"/><line any_info="No Anys on this line!" content="                immutable=True" number="165" precision="precise"/><line any_info="No Anys on this line!" content="            )" number="166" precision="empty"/><line any_info="No Anys on this line!" content="" number="167" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="            self._core_v1_api.create_namespaced_secret(self._namespace, secret)" number="168" precision="any"/><line any_info="No Anys on this line!" content="" number="169" precision="empty"/><line any_info="No Anys on this line!" content="            # Configuration must be already there before Operator deployment" number="170" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="            while self._retrieve_config_secret(pipeline.get_full_name()) is None:" number="171" precision="any"/><line any_info="No Anys on this line!" content="                time.sleep(1)" number="172" precision="precise"/><line any_info="No Anys on this line!" content="" number="173" precision="empty"/><line any_info="No Anys on this line!" content="            # Operator deployment" number="174" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x8)" content="            for operator in pipeline.get_protected().get_nested_instances().values():" number="175" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="                self._core_v1_api.create_namespaced_pod(" number="176" precision="any"/><line any_info="No Anys on this line!" content="                    self._namespace," number="177" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x4)&#10;Unimported (x2)" content="                    body=self._generate_pod_manifest(" number="178" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="                        operator," number="179" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="                        execution_mode if (ignore_operators is None) or (operator not in ignore_operators) else" number="180" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                        ExecutionMode.Skip" number="181" precision="any"/><line any_info="No Anys on this line!" content="                    )" number="182" precision="empty"/><line any_info="No Anys on this line!" content="                )" number="183" precision="empty"/><line any_info="No Anys on this line!" content="" number="184" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="            while wait and self.is_any_operator_in_state(pipeline.get_full_name(), DeploymentState.NotExisting):" number="185" precision="any"/><line any_info="No Anys on this line!" content="                time.sleep(1)" number="186" precision="precise"/><line any_info="No Anys on this line!" content="" number="187" precision="empty"/><line any_info="No Anys on this line!" content="        except Exception as e:" number="188" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="            if isinstance(e, ApiException):" number="189" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x7)" content="                self._logger.error(f&quot;Status: {e.status}; Reason: {e.reason}&quot;)" number="190" precision="any"/><line any_info="No Anys on this line!" content="" number="191" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="            self._logger.error(&quot;Rolling back deployment ...&quot;)" number="192" precision="any"/><line any_info="No Anys on this line!" content="" number="193" precision="empty"/><line any_info="No Anys on this line!" content="            # Delete deployed operators gracefully" number="194" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x8)" content="            for operator in pipeline.get_protected().get_nested_instances().values():" number="195" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x8)" content="                if DeploymentState.NotExisting != self.retrieve_operator_state(operator.get_full_name()):" number="196" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="                    self.destroy_operator(operator.get_full_name(), force=False, wait=False)" number="197" precision="any"/><line any_info="No Anys on this line!" content="" number="198" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x6)" content="            deployed_pods = self._retrieve_operator_pods(pipeline.get_full_name())" number="199" precision="any"/><line any_info="No Anys on this line!" content="" number="200" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="            while wait and (0 &lt; len(deployed_pods)):" number="201" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="                self._logger.debug(f&quot;Waiting for operators to be destroyed: {len(deployed_pods)}&quot;)" number="202" precision="any"/><line any_info="No Anys on this line!" content="                time.sleep(1)" number="203" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x6)" content="                deployed_pods = self._retrieve_operator_pods(pipeline.get_full_name())" number="204" precision="any"/><line any_info="No Anys on this line!" content="" number="205" precision="empty"/><line any_info="No Anys on this line!" content="            # Delete deployed secret" number="206" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="            if self._retrieve_config_secret(pipeline.get_full_name()) is not None:" number="207" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x6)" content="                self._core_v1_api.delete_namespaced_secret(pipeline.get_full_name(), self._namespace)" number="208" precision="any"/><line any_info="No Anys on this line!" content="" number="209" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="                while wait and (self._retrieve_config_secret(pipeline.get_full_name()) is not None):" number="210" precision="any"/><line any_info="No Anys on this line!" content="                    time.sleep(1)" number="211" precision="precise"/><line any_info="No Anys on this line!" content="" number="212" precision="empty"/><line any_info="No Anys on this line!" content="            raise" number="213" precision="empty"/><line any_info="No Anys on this line!" content="" number="214" precision="empty"/><line any_info="No Anys on this line!" content="    def destroy(self, pipeline_name: str, force: bool = False, wait: bool = True) -&gt; None:" number="215" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        deployed_pipeline = self.retrieve_deployed_pipeline(pipeline_name)" number="216" precision="imprecise"/><line any_info="No Anys on this line!" content="        # Delete deployed operators" number="217" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x8)" content="        for operator in deployed_pipeline.get_protected().get_nested_instances().values():" number="218" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x8)" content="            if DeploymentState.NotExisting != self.retrieve_operator_state(operator.get_full_name()):" number="219" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="                self.destroy_operator(operator.get_full_name(), force, wait=False)" number="220" precision="any"/><line any_info="No Anys on this line!" content="" number="221" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        deployed_pods = self._retrieve_operator_pods(pipeline_name)" number="222" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="223" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="        while wait and (0 &lt; len(deployed_pods)):" number="224" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="            self._logger.debug(f&quot;Waiting for operators to be destroyed: {len(deployed_pods)}&quot;)" number="225" precision="any"/><line any_info="No Anys on this line!" content="            time.sleep(1)" number="226" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="            deployed_pods = self._retrieve_operator_pods(pipeline_name)" number="227" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="228" precision="empty"/><line any_info="No Anys on this line!" content="        # Delete deployed secret" number="229" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="        if self._retrieve_config_secret(deployed_pipeline.get_full_name()) is not None:" number="230" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x6)" content="            self._core_v1_api.delete_namespaced_secret(deployed_pipeline.get_full_name(), self._namespace)" number="231" precision="any"/><line any_info="No Anys on this line!" content="" number="232" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="            while wait and (self._retrieve_config_secret(deployed_pipeline.get_full_name()) is not None):" number="233" precision="any"/><line any_info="No Anys on this line!" content="                time.sleep(1)" number="234" precision="precise"/><line any_info="No Anys on this line!" content="" number="235" precision="empty"/><line any_info="Any Types on this line: &#10;Unannotated (x1)" content="    def restart_operator(self, operator_full_name: str, force: bool = False, wait: bool = True):" number="236" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x1)&#10;Explicit (x1)" content="        operator_pod_name = KubernetesDeployer.sanitize(operator_full_name)" number="237" precision="precise"/><line any_info="No Anys on this line!" content="" number="238" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="        secret_list: V1SecretList = self._core_v1_api.list_namespaced_secret(self._namespace," number="239" precision="any"/><line any_info="No Anys on this line!" content="                                                                             label_selector=operator_pod_name)" number="240" precision="precise"/><line any_info="No Anys on this line!" content="" number="241" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="        if 0 == len(secret_list.items):" number="242" precision="any"/><line any_info="No Anys on this line!" content="            raise DeploymentException(f&quot;No pipeline configuration found for operator: {operator_full_name}&quot;)" number="243" precision="precise"/><line any_info="No Anys on this line!" content="" number="244" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="        if 1 &lt; len(secret_list.items):" number="245" precision="any"/><line any_info="No Anys on this line!" content="            raise DeploymentException(f&quot;Multiple pipeline configurations found for operator: {operator_full_name}&quot;)" number="246" precision="precise"/><line any_info="No Anys on this line!" content="" number="247" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="        secret: V1Secret = secret_list.items[0]" number="248" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="        operator_simple_name: str = secret.metadata.labels[operator_pod_name]" number="249" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x9)&#10;Explicit (x1)" content="        exec_mode: ExecutionMode = ExecutionMode(secret.metadata.labels[KubernetesDeployer._label_key_exec_mode])" number="250" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x6)" content="        deployed_pipeline: Pipeline = self._retrieve_deployed_pipeline_from_secret(secret)" number="251" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x7)" content="        operator: Operator = deployed_pipeline.get_protected().get_nested_instance(operator_simple_name)" number="252" precision="any"/><line any_info="No Anys on this line!" content="" number="253" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="        if self._retrieve_operator_pod(operator_pod_name) is not None:" number="254" precision="imprecise"/><line any_info="No Anys on this line!" content="            self.destroy_operator(operator_pod_name, force)" number="255" precision="precise"/><line any_info="No Anys on this line!" content="" number="256" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        self._core_v1_api.create_namespaced_pod(self._namespace," number="257" precision="any"/><line any_info="Any Types on this line: &#10;Omitted Generics (x4)&#10;Unimported (x4)" content="                                                body=self._generate_pod_manifest(operator, exec_mode))" number="258" precision="any"/><line any_info="No Anys on this line!" content="" number="259" precision="empty"/><line any_info="No Anys on this line!" content="    def destroy_operator(self, operator_full_name: str, force: bool = False, wait: bool = True) -&gt; None:" number="260" precision="precise"/><line any_info="No Anys on this line!" content="        if force:" number="261" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x4)&#10;Explicit (x1)" content="            self._core_v1_api.delete_namespaced_pod(name=KubernetesDeployer.sanitize(operator_full_name)," number="262" precision="any"/><line any_info="No Anys on this line!" content="                                                    namespace=self._namespace, grace_period_seconds=0)" number="263" precision="precise"/><line any_info="No Anys on this line!" content="        else:" number="264" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x4)&#10;Explicit (x1)" content="            self._core_v1_api.delete_namespaced_pod(name=KubernetesDeployer.sanitize(operator_full_name)," number="265" precision="any"/><line any_info="No Anys on this line!" content="                                                    namespace=self._namespace)" number="266" precision="precise"/><line any_info="No Anys on this line!" content="" number="267" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="        while wait and (self._retrieve_operator_pod(operator_full_name) is not None):" number="268" precision="imprecise"/><line any_info="No Anys on this line!" content="            time.sleep(1)" number="269" precision="precise"/><line any_info="No Anys on this line!" content="" number="270" precision="empty"/><line any_info="No Anys on this line!" content="    def is_deployed(self, pipeline_name: str) -&gt; bool:" number="271" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="        return self._retrieve_config_secret(pipeline_name) is not None" number="272" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="273" precision="empty"/><line any_info="No Anys on this line!" content="    def retrieve_pipeline_deployments(self) -&gt; set[str]:" number="274" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="        secret_list: V1SecretList = self._core_v1_api.list_namespaced_secret(" number="275" precision="any"/><line any_info="No Anys on this line!" content="            self._namespace," number="276" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x2)&#10;Explicit (x2)" content="            label_selector=f&quot;{KubernetesDeployer._label_key_instance_type}={KubernetesDeployer._label_value_pipeline}&quot;)" number="277" precision="precise"/><line any_info="No Anys on this line!" content="" number="278" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x6)" content="        return {secret.metadata.name for secret in secret_list.items}" number="279" precision="any"/><line any_info="No Anys on this line!" content="" number="280" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="    def retrieve_deployed_pipeline(self, pipeline_name: str) -&gt; Optional[Pipeline]:" number="281" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="        return self._retrieve_deployed_pipeline_from_secret(self._retrieve_config_secret(pipeline_name))" number="282" precision="any"/><line any_info="No Anys on this line!" content="" number="283" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="    def retrieve_operator_state(self, operator_full_name: str) -&gt; DeploymentState:" number="284" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        pod = self._retrieve_operator_pod(operator_full_name)" number="285" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="286" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="        if pod is None:" number="287" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="            return DeploymentState.NotExisting" number="288" precision="any"/><line any_info="No Anys on this line!" content="" number="289" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="        if (pod.status is None) or (pod.status.phase is None):" number="290" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="            return DeploymentState.Unknown" number="291" precision="any"/><line any_info="No Anys on this line!" content="" number="292" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        match pod.status.phase:" number="293" precision="any"/><line any_info="No Anys on this line!" content="            case &quot;Pending&quot;:" number="294" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                return DeploymentState.Open" number="295" precision="any"/><line any_info="No Anys on this line!" content="            case &quot;Running&quot;:" number="296" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                return DeploymentState.Running" number="297" precision="any"/><line any_info="No Anys on this line!" content="            case &quot;Succeeded&quot;:" number="298" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                return DeploymentState.Completed" number="299" precision="any"/><line any_info="No Anys on this line!" content="            case &quot;Failed&quot;:" number="300" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                return DeploymentState.Failed" number="301" precision="any"/><line any_info="No Anys on this line!" content="            case _:" number="302" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                return DeploymentState.Unknown" number="303" precision="any"/><line any_info="No Anys on this line!" content="" number="304" precision="empty"/><line any_info="Any Types on this line: &#10;Unannotated (x1)" content="    def retrieve_operator_logs(self, operator_full_name: str, **kwargs) -&gt; Optional[str]:" number="305" precision="any"/><line any_info="No Anys on this line!" content="        try:" number="306" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x4)&#10;Explicit (x1)" content="            return self._core_v1_api.read_namespaced_pod_log(name=KubernetesDeployer.sanitize(operator_full_name)," number="307" precision="any"/><line any_info="No Anys on this line!" content="                                                             namespace=self._namespace," number="308" precision="precise"/><line any_info="Any Types on this line: &#10;Unannotated (x1)" content="                                                             **kwargs)" number="309" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="        except ApiException as e:" number="310" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="            if 404 == e.status:" number="311" precision="any"/><line any_info="No Anys on this line!" content="                return None" number="312" precision="precise"/><line any_info="No Anys on this line!" content="            raise" number="313" precision="empty"/><line any_info="No Anys on this line!" content="" number="314" precision="empty"/><line any_info="No Anys on this line!" content="    # ========================= helper methods ==========================" number="315" precision="empty"/><line any_info="No Anys on this line!" content="" number="316" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="    def _retrieve_config_secret(self, pipeline_name: str) -&gt; Optional[V1Secret]:" number="317" precision="imprecise"/><line any_info="No Anys on this line!" content="        try:" number="318" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="            return self._core_v1_api.read_namespaced_secret(pipeline_name, self._namespace)" number="319" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="        except ApiException as e:" number="320" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="            if 404 == e.status:" number="321" precision="any"/><line any_info="No Anys on this line!" content="                return None" number="322" precision="precise"/><line any_info="No Anys on this line!" content="            raise" number="323" precision="empty"/><line any_info="No Anys on this line!" content="" number="324" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="    def _retrieve_deployed_pipeline_from_secret(self, secret: V1Secret) -&gt; Optional[Pipeline]:" number="325" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)&#10;Explicit (x1)" content="        if KubernetesDeployer._pipeline_config_secret_key not in secret.data:" number="326" precision="any"/><line any_info="No Anys on this line!" content="            raise DeploymentException(&quot;Provided secret is not pipeline configuration secret&quot;)" number="327" precision="precise"/><line any_info="No Anys on this line!" content="" number="328" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        return Pipeline.create_from_string(base64.b64decode(" number="329" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x4)&#10;Explicit (x1)" content="            secret.data[KubernetesDeployer._pipeline_config_secret_key]))" number="330" precision="any"/><line any_info="No Anys on this line!" content="" number="331" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="    def _retrieve_operator_pod(self, operator_full_name: str) -&gt; Optional[V1Pod]:" number="332" precision="imprecise"/><line any_info="No Anys on this line!" content="        try:" number="333" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x4)&#10;Explicit (x1)" content="            return self._core_v1_api.read_namespaced_pod(KubernetesDeployer.sanitize(operator_full_name)," number="334" precision="any"/><line any_info="No Anys on this line!" content="                                                         self._namespace)" number="335" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="        except ApiException as e:" number="336" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="            if 404 == e.status:" number="337" precision="any"/><line any_info="No Anys on this line!" content="                return None" number="338" precision="precise"/><line any_info="No Anys on this line!" content="            raise" number="339" precision="empty"/><line any_info="No Anys on this line!" content="" number="340" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="    def _retrieve_operator_pods(self, pipeline_name: str) -&gt; list[V1Pod]:" number="341" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="        return self._core_v1_api.list_namespaced_pod(" number="342" precision="any"/><line any_info="No Anys on this line!" content="            self._namespace," number="343" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x1)&#10;Explicit (x1)" content="            label_selector=f&quot;{KubernetesDeployer._label_key_part_of}={pipeline_name}&quot;" number="344" precision="precise"/><line any_info="No Anys on this line!" content="        ).items" number="345" precision="empty"/><line any_info="No Anys on this line!" content="" number="346" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x2)&#10;Omitted Generics (x2)" content="    def _generate_pod_manifest(self, operator: Operator, execution_mode: ExecutionMode) -&gt; dict:" number="347" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        if operator.get_operator_image_name() is None:" number="348" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="            raise DeploymentException(f&quot;[{operator.get_full_name()}] Image name must be specified&quot;)" number="349" precision="any"/><line any_info="No Anys on this line!" content="" number="350" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x4)&#10;Explicit (x1)" content="        operator_pod_name = KubernetesDeployer.sanitize(operator.get_full_name())" number="351" precision="any"/><line any_info="No Anys on this line!" content="" number="352" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="        if operator.has_parameter(&quot;kubernetes&quot;):" number="353" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x4)" content="            parameters = operator.get_parameter(&quot;kubernetes&quot;)" number="354" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x1)&#10;Omitted Generics (x18)" content="            if isinstance(parameters, dict):" number="355" precision="any"/><line any_info="Any Types on this line: &#10;Omitted Generics (x20)" content="                kubernetes_parameters: KubernetesParameter = KubernetesParameter(**parameters)" number="356" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x1)&#10;Omitted Generics (x20)" content="            elif isinstance(parameters, KubernetesParameter):" number="357" precision="any"/><line any_info="Any Types on this line: &#10;Error (x1)" content="                kubernetes_parameters: KubernetesParameter = parameters" number="358" precision="any"/><line any_info="No Anys on this line!" content="            else:" number="359" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="                raise TypeError(f&quot;Invalid kubernetes parameter type for '{operator.get_full_name()}': &quot;" number="360" precision="any"/><line any_info="Any Types on this line: &#10;Explicit (x2)&#10;Unimported (x1)" content="                                f&quot;{type(parameters)}&quot;)" number="361" precision="any"/><line any_info="No Anys on this line!" content="        else:" number="362" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x20)&#10;Error (x1)" content="            kubernetes_parameters: KubernetesParameter = KubernetesParameter()" number="363" precision="any"/><line any_info="No Anys on this line!" content="" number="364" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="        env = [" number="365" precision="imprecise"/><line any_info="No Anys on this line!" content="            {" number="366" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)&#10;Explicit (x1)" content="                'name': KubernetesDeployer._env_var_operator_name," number="367" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="                'value': operator.get_simple_name()," number="368" precision="any"/><line any_info="No Anys on this line!" content="            }," number="369" precision="empty"/><line any_info="No Anys on this line!" content="            {" number="370" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)&#10;Explicit (x1)" content="                'name': KubernetesDeployer._env_var_operator_exec_mode," number="371" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x2)" content="                'value': execution_mode.value" number="372" precision="any"/><line any_info="No Anys on this line!" content="            }" number="373" precision="empty"/><line any_info="No Anys on this line!" content="        ]" number="374" precision="empty"/><line any_info="No Anys on this line!" content="" number="375" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="        if kubernetes_parameters.env is not None:" number="376" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x2)&#10;Omitted Generics (x2)" content="            env.extend(kubernetes_parameters.env)" number="377" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="378" precision="empty"/><line any_info="No Anys on this line!" content="        volume_mounts = [" number="379" precision="precise"/><line any_info="No Anys on this line!" content="            {" number="380" precision="empty"/><line any_info="No Anys on this line!" content="                'mountPath': '/operator/config'," number="381" precision="precise"/><line any_info="No Anys on this line!" content="                'name': operator_pod_name" number="382" precision="precise"/><line any_info="No Anys on this line!" content="            }" number="383" precision="empty"/><line any_info="No Anys on this line!" content="        ]" number="384" precision="empty"/><line any_info="No Anys on this line!" content="" number="385" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="        if kubernetes_parameters.volumeMounts is not None:" number="386" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="            volume_mounts.extend(kubernetes_parameters.volumeMounts)" number="387" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="388" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="        security_context = {" number="389" precision="imprecise"/><line any_info="No Anys on this line!" content="            'privileged': True" number="390" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x4)" content="        } if kubernetes_parameters.containerSecurityContext is None else kubernetes_parameters.containerSecurityContext" number="391" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="392" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="        containers = [" number="393" precision="imprecise"/><line any_info="No Anys on this line!" content="            {" number="394" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="                'env': env," number="395" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="                'envFrom': kubernetes_parameters.envFrom," number="396" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x3)" content="                'image': operator.get_operator_image_name()," number="397" precision="any"/><line any_info="No Anys on this line!" content="                'imagePullPolicy': 'Always'" number="398" precision="precise"/><line any_info="No Anys on this line!" content="                if kubernetes_parameters.imagePullPolicy is None else kubernetes_parameters.imagePullPolicy," number="399" precision="precise"/><line any_info="No Anys on this line!" content="                'name': operator_pod_name," number="400" precision="precise"/><line any_info="No Anys on this line!" content="                'volumeMounts': volume_mounts," number="401" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="                'securityContext': security_context" number="402" precision="imprecise"/><line any_info="No Anys on this line!" content="            }" number="403" precision="empty"/><line any_info="No Anys on this line!" content="        ]" number="404" precision="empty"/><line any_info="No Anys on this line!" content="" number="405" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="        if kubernetes_parameters.containers is not None:" number="406" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x2)&#10;Omitted Generics (x2)" content="            containers.extend(kubernetes_parameters.containers)" number="407" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="408" precision="empty"/><line any_info="No Anys on this line!" content="        volumes = [" number="409" precision="precise"/><line any_info="No Anys on this line!" content="            {" number="410" precision="empty"/><line any_info="No Anys on this line!" content="                'name': operator_pod_name," number="411" precision="precise"/><line any_info="No Anys on this line!" content="                'secret': {" number="412" precision="precise"/><line any_info="No Anys on this line!" content="                    'defaultMode': 493," number="413" precision="precise"/><line any_info="No Anys on this line!" content="                    'items': [" number="414" precision="precise"/><line any_info="No Anys on this line!" content="                        {" number="415" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)&#10;Explicit (x1)" content="                            'key': KubernetesDeployer._pipeline_config_secret_key," number="416" precision="precise"/><line any_info="No Anys on this line!" content="                            'mode': 493," number="417" precision="precise"/><line any_info="No Anys on this line!" content="                            'path': 'config.json'" number="418" precision="precise"/><line any_info="No Anys on this line!" content="                        }" number="419" precision="empty"/><line any_info="No Anys on this line!" content="                    ]," number="420" precision="empty"/><line any_info="No Anys on this line!" content="                    'optional': False," number="421" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x5)" content="                    'secretName': operator.get_context().get_full_name()" number="422" precision="any"/><line any_info="No Anys on this line!" content="                }" number="423" precision="empty"/><line any_info="No Anys on this line!" content="            }" number="424" precision="empty"/><line any_info="No Anys on this line!" content="        ]" number="425" precision="empty"/><line any_info="No Anys on this line!" content="" number="426" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="        if kubernetes_parameters.volumes is not None:" number="427" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="            volumes.extend(kubernetes_parameters.volumes)" number="428" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="429" precision="empty"/><line any_info="No Anys on this line!" content="        topology_spread_constraints = [" number="430" precision="precise"/><line any_info="No Anys on this line!" content="            {" number="431" precision="empty"/><line any_info="No Anys on this line!" content="                'labelSelector': {" number="432" precision="precise"/><line any_info="No Anys on this line!" content="                    'matchLabels': {" number="433" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x6)&#10;Explicit (x1)" content="                        KubernetesDeployer._label_key_part_of: operator.get_context().get_full_name()" number="434" precision="any"/><line any_info="No Anys on this line!" content="                    }" number="435" precision="empty"/><line any_info="No Anys on this line!" content="                }," number="436" precision="empty"/><line any_info="No Anys on this line!" content="                'maxSkew': 1," number="437" precision="precise"/><line any_info="No Anys on this line!" content="                'topologyKey': 'kubernetes.io/hostname'," number="438" precision="precise"/><line any_info="No Anys on this line!" content="                'whenUnsatisfiable': 'ScheduleAnyway'" number="439" precision="precise"/><line any_info="No Anys on this line!" content="            }" number="440" precision="empty"/><line any_info="No Anys on this line!" content="        ]" number="441" precision="empty"/><line any_info="No Anys on this line!" content="" number="442" precision="empty"/><line any_info="No Anys on this line!" content="        spec = {" number="443" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="            'containers': containers," number="444" precision="imprecise"/><line any_info="No Anys on this line!" content="            'restartPolicy': 'Never'" number="445" precision="precise"/><line any_info="No Anys on this line!" content="            if kubernetes_parameters.restartPolicy is None else kubernetes_parameters.restartPolicy," number="446" precision="precise"/><line any_info="No Anys on this line!" content="            'serviceAccountName': 'default' if kubernetes_parameters.serviceAccountName is None else" number="447" precision="precise"/><line any_info="No Anys on this line!" content="            kubernetes_parameters.serviceAccountName," number="448" precision="precise"/><line any_info="No Anys on this line!" content="            'terminationGracePeriodSeconds': 300 if kubernetes_parameters.terminationGracePeriodSeconds is None else" number="449" precision="precise"/><line any_info="No Anys on this line!" content="            kubernetes_parameters.terminationGracePeriodSeconds," number="450" precision="precise"/><line any_info="No Anys on this line!" content="            'topologySpreadConstraints': topology_spread_constraints," number="451" precision="precise"/><line any_info="No Anys on this line!" content="            'volumes': volumes," number="452" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="            'securityContext': kubernetes_parameters.podSecurityContext" number="453" precision="imprecise"/><line any_info="No Anys on this line!" content="        }" number="454" precision="empty"/><line any_info="No Anys on this line!" content="" number="455" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x4)" content="        if (kubernetes_parameters.nodeAffinity is not None) or (kubernetes_parameters.nodeAntiAffinity is not None):" number="456" precision="imprecise"/><line any_info="No Anys on this line!" content="            node_selector_terms = []" number="457" precision="precise"/><line any_info="No Anys on this line!" content="" number="458" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="            if kubernetes_parameters.nodeAffinity is not None:" number="459" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="                node_selector_terms.append({" number="460" precision="imprecise"/><line any_info="No Anys on this line!" content="                    'matchExpressions': [" number="461" precision="precise"/><line any_info="No Anys on this line!" content="                        {" number="462" precision="empty"/><line any_info="No Anys on this line!" content="                            'key': &quot;kubernetes.io/hostname&quot;," number="463" precision="precise"/><line any_info="No Anys on this line!" content="                            'operator': 'In'," number="464" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="                            'values': kubernetes_parameters.nodeAffinity" number="465" precision="imprecise"/><line any_info="No Anys on this line!" content="                        }" number="466" precision="empty"/><line any_info="No Anys on this line!" content="                    ]" number="467" precision="empty"/><line any_info="No Anys on this line!" content="                })" number="468" precision="empty"/><line any_info="No Anys on this line!" content="" number="469" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="            if kubernetes_parameters.nodeAntiAffinity is not None:" number="470" precision="imprecise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="                node_selector_terms.append({" number="471" precision="imprecise"/><line any_info="No Anys on this line!" content="                    'matchExpressions': [" number="472" precision="precise"/><line any_info="No Anys on this line!" content="                        {" number="473" precision="empty"/><line any_info="No Anys on this line!" content="                            'key': &quot;kubernetes.io/hostname&quot;," number="474" precision="precise"/><line any_info="No Anys on this line!" content="                            'operator': 'NotIn'," number="475" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="                            'values': kubernetes_parameters.nodeAntiAffinity" number="476" precision="imprecise"/><line any_info="No Anys on this line!" content="                        }" number="477" precision="empty"/><line any_info="No Anys on this line!" content="                    ]" number="478" precision="empty"/><line any_info="No Anys on this line!" content="                })" number="479" precision="empty"/><line any_info="No Anys on this line!" content="" number="480" precision="empty"/><line any_info="No Anys on this line!" content="            spec['affinity'] = {" number="481" precision="precise"/><line any_info="No Anys on this line!" content="                'nodeAffinity': {" number="482" precision="precise"/><line any_info="No Anys on this line!" content="                    'requiredDuringSchedulingIgnoredDuringExecution': {" number="483" precision="precise"/><line any_info="Any Types on this line: &#10;Omitted Generics (x1)" content="                        'nodeSelectorTerms': node_selector_terms" number="484" precision="imprecise"/><line any_info="No Anys on this line!" content="                    }" number="485" precision="empty"/><line any_info="No Anys on this line!" content="                }" number="486" precision="empty"/><line any_info="No Anys on this line!" content="            }" number="487" precision="empty"/><line any_info="No Anys on this line!" content="" number="488" precision="empty"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="        labels = {" number="489" precision="imprecise"/><line any_info="Any Types on this line: &#10;Unimported (x2)&#10;Explicit (x2)" content="            KubernetesDeployer._label_key_instance_type: KubernetesDeployer._label_value_operator," number="490" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x6)&#10;Explicit (x1)" content="            KubernetesDeployer._label_key_part_of: operator.get_context().get_full_name()," number="491" precision="any"/><line any_info="Any Types on this line: &#10;Unimported (x4)&#10;Explicit (x1)" content="            KubernetesDeployer._label_key_instance_name: operator.get_simple_name()" number="492" precision="any"/><line any_info="No Anys on this line!" content="        }" number="493" precision="empty"/><line any_info="No Anys on this line!" content="" number="494" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x2)" content="        if kubernetes_parameters.labels is not None:" number="495" precision="imprecise"/><line any_info="No Anys on this line!" content="            # This is how we ensure that basic labels are not getting overwritten" number="496" precision="empty"/><line any_info="Any Types on this line: &#10;Omitted Generics (x9)&#10;Unimported (x2)" content="            labels = kubernetes_parameters.labels.update(labels)" number="497" precision="imprecise"/><line any_info="No Anys on this line!" content="" number="498" precision="empty"/><line any_info="No Anys on this line!" content="        metadata = {" number="499" precision="precise"/><line any_info="Any Types on this line: &#10;Unimported (x1)" content="            'labels': labels," number="500" precision="imprecise"/><line any_info="No Anys on this line!" content="            'name': operator_pod_name," number="501" precision="precise"/><line any_info="No Anys on this line!" content="        }" number="502" precision="empty"/><line any_info="No Anys on this line!" content="" number="503" precision="empty"/><line any_info="No Anys on this line!" content="        return {" number="504" precision="empty"/><line any_info="No Anys on this line!" content="            'apiVersion': 'v1'," number="505" precision="precise"/><line any_info="No Anys on this line!" content="            'kind': 'Pod'," number="506" precision="precise"/><line any_info="No Anys on this line!" content="            'metadata': metadata," number="507" precision="precise"/><line any_info="No Anys on this line!" content="            'spec': spec" number="508" precision="precise"/><line any_info="No Anys on this line!" content="        }" number="509" precision="empty"/></mypy-report-file>